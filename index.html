<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Renda Fixa com Gráficos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 2rem auto;
    padding: 1.5rem;
    background: #f9f9f9;
    color: #222;
  }
  h1 {
    color: #4a148c;
    margin-bottom: 1rem;
    text-align: center;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  label {
    font-weight: bold;
    display: block;
    margin-bottom: 0.3rem;
  }
  input[type=number], select {
    width: 100%;
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .info-box {
    background: white;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.05);
  }
  .info-title {
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: #4a148c;
  }
  .period-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .period-controls button {
    width: 30px;
    font-weight: bold;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .result {
    background: #e1bee7;
    padding: 1rem 1.2rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 1.2rem;
    color: #2e0854;
    margin-bottom: 2rem;
  }
  footer {
    margin-top: 3rem;
    text-align: center;
    font-weight: bold;
    font-size: 1rem;
    color: #4a148c;
  }
  canvas {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px #ccc;
  }
</style>
</head>
<body>
  <h1>Calculadora de Renda Fixa com Gráficos</h1>

  <div class="grid">
    <div>
      <label for="investimentoInicial">Investimento inicial (R$)</label>
      <input type="number" id="investimentoInicial" min="0" step="0.01" value="0" />
    </div>
    <div>
      <label for="aportesMensais">Aportes mensais (R$)</label>
      <input type="number" id="aportesMensais" min="0" step="0.01" value="0" />
    </div>
    <div>
      <label for="periodo">Período da aplicação</label>
      <div class="period-controls">
        <button type="button" onclick="decrementPeriodo()">−</button>
        <input type="number" id="periodo" min="0" step="1" value="12" style="width: 60px; text-align:center;" />
        <button type="button" onclick="incrementPeriodo()">+</button>
        <select id="periodoUnidade" onchange="calcular()">
          <option value="meses" selected>meses</option>
          <option value="anos">anos</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="info-box">
      <div class="info-title">Selic efetiva (a.a.)</div>
      <input type="number" id="selic" step="0.01" value="14.90" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">CDI (a.a.)</div>
      <input type="number" id="cdi" step="0.01" value="14.90" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">IPCA (a.a.)</div>
      <input type="number" id="ipca" step="0.0001" value="4.69" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">TR (a.m.)</div>
      <input type="number" id="tr" step="0.0001" value="0.1739" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Juro nominal do Tesouro Prefixado (a.a.)</div>
      <input type="number" id="tesouroPrefixado" step="0.01" value="14.00" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Taxa de custódia da B3 no Tesouro Direto (a.a.)</div>
      <input type="number" id="taxaCustodia" step="0.01" value="0.20" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Juro real do Tesouro IPCA+ (a.a.)</div>
      <input type="number" id="tesouroIPCA" step="0.01" value="6.50" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Taxa de administração do Fundo DI (a.a.)</div>
      <input type="number" id="taxaAdmFundoDI" step="0.01" value="0.25" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Rentabilidade do CDB (% do CDI)</div>
      <input type="number" id="rentCDB" step="0.01" value="100" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Rentabilidade do Fundo DI (% do CDI)</div>
      <input type="number" id="rentFundoDI" step="0.01" value="98.17" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Rentabilidade da LCI/LCA (% do CDI)</div>
      <input type="number" id="rentLCI" step="0.01" value="85" onchange="calcular()" />
    </div>
    <div class="info-box">
      <div class="info-title">Rentabilidade da Poupança (a.m.)</div>
      <input type="number" id="rentPoupanca" step="0.0001" value="0.6748" onchange="calcular()" />
    </div>
  </div>

  <div class="result" id="resultado">Calculando...</div>

  <canvas id="graficoInvestimentos" height="400"></canvas>

  <footer>
    Criado por <strong>rvs</strong>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function incrementPeriodo() {
      const periodoInput = document.getElementById('periodo');
      periodoInput.value = parseInt(periodoInput.value || '0') + 1;
      calcular();
    }
    function decrementPeriodo() {
      const periodoInput = document.getElementById('periodo');
      if (periodoInput.value > 0) {
        periodoInput.value = parseInt(periodoInput.value) - 1;
        calcular();
      }
    }

    function valorFinalComAportes(P, A, i, n) {
      if (i === 0) return P + A * n;
      return P * Math.pow(1 + i, n) + A * (Math.pow(1 + i, n) - 1) / i;
    }

    function calcular() {
      // Inputs básicos
      const investimentoInicial = parseFloat(document.getElementById('investimentoInicial').value) || 0;
      const aportesMensais = parseFloat(document.getElementById('aportesMensais').value) || 0;
      let periodo = parseInt(document.getElementById('periodo').value) || 0;
      const unidade = document.getElementById('periodoUnidade').value;

      if (unidade === 'anos') {
        periodo *= 12;
      }
      if (periodo === 0) {
        document.getElementById('resultado').innerHTML = 'Informe um período maior que zero.';
        if (window.chartInvestimentos) {
          window.chartInvestimentos.destroy();
        }
        return;
      }

      // Taxas anuais e mensais
      const selic = parseFloat(document.getElementById('selic').value) / 100;
      const cdi = parseFloat(document.getElementById('cdi').value) / 100;
      const ipca = parseFloat(document.getElementById('ipca').value) / 100;
      const tr = parseFloat(document.getElementById('tr').value) / 100;

      const tesouroPrefixado = parseFloat(document.getElementById('tesouroPrefixado').value) / 100;
      const taxaCustodia = parseFloat(document.getElementById('taxaCustodia').value) / 100;
      const tesouroIPCA = parseFloat(document.getElementById('tesouroIPCA').value) / 100;
      const taxaAdmFundoDI = parseFloat(document.getElementById('taxaAdmFundoDI').value) / 100;

      const rentCDB = parseFloat(document.getElementById('rentCDB').value) / 100;
      const rentFundoDI = parseFloat(document.getElementById('rentFundoDI').value) / 100;
      const rentLCI = parseFloat(document.getElementById('rentLCI').value) / 100;
      const rentPoupanca = parseFloat(document.getElementById('rentPoupanca').value) / 100;

      // Converter taxas anuais para mensais compostas
      const cdiMes = Math.pow(1 + cdi, 1/12) - 1;
      const selicMes = Math.pow(1 + selic, 1/12) - 1;
      const ipcaMes = Math.pow(1 + ipca, 1/12) - 1;
      const trMes = tr; // TR já é mensal

      // Taxa mensal líquidos descontando taxas e taxas de custódia aproximadas
      // Tesouro Prefixado descontando taxa custódia (simplificado)
      const tesouroPrefixadoMes = Math.pow(1 + tesouroPrefixado, 1/12) - 1 - taxaCustodia/12;
      // Tesouro IPCA descontando taxa custódia
      const tesouroIPCAMes = Math.pow(1 + tesouroIPCA + ipca, 1/12) - 1 - taxaCustodia/12;
      // CDB
      const cdbMes = cdiMes * rentCDB;
      // Fundo DI descontando taxa adm
      const fundoDIMes = cdiMes * rentFundoDI * (1 - taxaAdmFundoDI);
      // LCI/LCA (isento IR, simplificado)
      const lciMes = cdiMes * rentLCI;
      // Poupança já mensal direto
      const poupancaMes = rentPoupanca;

      // Calcular valores finais
      const vfCDB = valorFinalComAportes(investimentoInicial, aportesMensais, cdbMes, periodo);
      const vfFundoDI = valorFinalComAportes(investimentoInicial, aportesMensais, fundoDIMes, periodo);
      const vfLCI = valorFinalComAportes(investimentoInicial, aportesMensais, lciMes, periodo);
      const vfPoupanca = valorFinalComAportes(investimentoInicial, aportesMensais, poupancaMes, periodo);
      const vfTesouroPre = valorFinalComAportes(investimentoInicial, aportesMensais, tesouroPrefixadoMes, periodo);
      const vfTesouroIPCA = valorFinalComAportes(investimentoInicial, aportesMensais, tesouroIPCAMes, periodo);

      // Mostrar resultados formatados
      function formatBRL(val) {
        return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      const resultadoHTML = `
        <p><strong>Valor final estimado para o CDB:</strong> ${formatBRL(vfCDB)}</p>
        <p><strong>Valor final estimado para o Fundo DI:</strong> ${formatBRL(vfFundoDI)}</p>
        <p><strong>Valor final estimado para a LCI/LCA:</strong> ${formatBRL(vfLCI)}</p>
        <p><strong>Valor final estimado para a Poupança:</strong> ${formatBRL(vfPoupanca)}</p>
        <p><strong>Valor final estimado para Tesouro Prefixado:</strong> ${formatBRL(vfTesouroPre)}</p>
        <p><strong>Valor final estimado para Tesouro IPCA+:</strong> ${formatBRL(vfTesouroIPCA)}</p>
      `;

      document.getElementById('resultado').innerHTML = resultadoHTML;

      // Dados para gráfico
      const labels = [];
      const dataCDB = [];
      const dataFundoDI = [];
      const dataLCI = [];
      const dataPoupanca = [];
      const dataTesouroPre = [];
      const dataTesouroIPCA = [];

      for (let m = 0; m <= periodo; m++) {
        labels.push(m);

        dataCDB.push(valorFinalComAportes(investimentoInicial, aportesMensais, cdbMes, m));
        dataFundoDI.push(valorFinalComAportes(investimentoInicial, aportesMensais, fundoDIMes, m));
        dataLCI.push(valorFinalComAportes(investimentoInicial, aportesMensais, lciMes, m));
        dataPoupanca.push(valorFinalComAportes(investimentoInicial, aportesMensais, poupancaMes, m));
        dataTesouroPre.push(valorFinalComAportes(investimentoInicial, aportesMensais, tesouroPrefixadoMes, m));
        dataTesouroIPCA.push(valorFinalComAportes(investimentoInicial, aportesMensais, tesouroIPCAMes, m));
      }

      // Criar gráfico ou atualizar
      if(window.chartInvestimentos) {
        window.chartInvestimentos.data.labels = labels;
        window.chartInvestimentos.data.datasets[0].data = dataCDB;
        window.chartInvestimentos.data.datasets[1].data = dataFundoDI;
        window.chartInvestimentos.data.datasets[2].data = dataLCI;
        window.chartInvestimentos.data.datasets[3].data = dataPoupanca;
        window.chartInvestimentos.data.datasets[4].data = dataTesouroPre;
        window.chartInvestimentos.data.datasets[5].data = dataTesouroIPCA;
        window.chartInvestimentos.update();
      } else {
        const ctx = document.getElementById('graficoInvestimentos').getContext('2d');
        window.chartInvestimentos = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'CDB', data: dataCDB, borderColor: '#7b1fa2', fill: false },
              { label: 'Fundo DI', data: dataFundoDI, borderColor: '#9c27b0', fill: false },
              { label: 'LCI/LCA', data: dataLCI, borderColor: '#ba68c8', fill: false },
              { label: 'Poupança', data: dataPoupanca, borderColor: '#ce93d8', fill: false },
              { label: 'Tesouro Prefixado', data: dataTesouroPre, borderColor: '#6a1b9a', fill: false },
              { label: 'Tesouro IPCA+', data: dataTesouroIPCA, borderColor: '#4a148c', fill: false },
            ]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Meses'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Valor acumulado (R$)'
                },
                beginAtZero: true
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 15,
                  padding: 15,
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                  }
                }
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            }
          }
        });
      }
    }

    window.onload = calcular;
  </script>
    <script>
  async function carregarIndices() {
    try {
      const response = await fetch('https://calculadora-rvs.up.railway.app/indices');
      if (!response.ok) throw new Error('Erro ao buscar índices');
      const dados = await response.json();

      document.getElementById('selic').value = dados.selic || 0;
      document.getElementById('cdi').value = dados.cdi * 100 || 0;
      document.getElementById('ipca').value = dados.ipca * 100 || 0;
      document.getElementById('tr').value = dados.tr || 0;

      calcular(); // Recalcula após atualizar os valores
    } catch (error) {
      alert('Não foi possível atualizar os índices.');
      console.error(error);
    }
  }

  window.onload = function() {
    carregarIndices();
    calcular();
  };
  </script>
</body>
</html>

